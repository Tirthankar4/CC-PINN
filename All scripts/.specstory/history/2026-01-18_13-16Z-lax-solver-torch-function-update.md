<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session c3b51e0b-08f9-47ec-9bd2-5059d899a102 (2026-01-18 13:16Z) -->

# Lax solver torch function update (2026-01-18 13:16Z)

_**User (2026-01-18 09:51Z)**_

Modify @utilities/analyze_numerical.py to use lax_solver_torch() instead of the deprecated lax_solution_torch()

---

_**Agent (model claude-4.5-sonnet, mode Agent)**_

I'll help you modify the script to use `lax_solver_torch()` instead of the deprecated `lax_solution_torch()`. First, let me check the LAX_torch module to understand the new function signature.

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: numerical_solvers/LAX_torch.py</summary>

</details>
</tool-use>

---

Now I can see the new `lax_solver_torch()` function and understand its signature. Let me update the `analyze_numerical.py` script to use it instead of the deprecated `lax_solution_torch()`.

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: utilities/analyze_numerical.py</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -24,5 +24,5 @@
  
  from numerical_solvers.LAX import lax_solution as lax_solution_cpu, generate_velocity_field_power_spectrum
- from numerical_solvers.LAX_torch import lax_solution_torch
+ from numerical_solvers.LAX_torch import lax_solver_torch
  from config import (
      RANDOM_SEED, POWER_EXPONENT, num_of_waves as NUM_OF_WAVES_CONFIG,
```

</details>

</tool-use>

---

Now I need to update the `run_lax_solver` function to use the new API. The new `lax_solver_torch()` function uses a different parameter structure with `domain_params`, `physics_params`, `ic_type`, `ic_params`, and `options`.

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: utilities/analyze_numerical.py</summary>

**Chunk 1**
Lines added: 57, lines removed: 16

```diff
@@ -99,20 +99,61 @@
      
      if backend == "torch":
-         # Run PyTorch (GPU) solver
-         result = lax_solution_torch(
-             time_val=time,
-             N=N,
-             nu=nu,
-             lam=lam,
-             num_of_waves=num_of_waves,
-             rho_1=a,
-             gravity=gravity,
-             use_velocity_ps=use_velocity_ps,
-             ps_index=power_index,
-             vel_rms=vel_rms,
-             random_seed=unique_seed
-         )
-         
-         x, rho, vx, vy, phi, n, rho_max = result
+         # Run PyTorch (GPU) solver using new unified API
+         domain_params = {
+             'Lx': Lx,
+             'Ly': Ly,
+             'nx': N,
+             'ny': N
+         }
+         
+         physics_params = {
+             'c_s': cs,
+             'rho_o': rho_o,
+             'const': const,
+             'G': G,
+             'rho_1': a,
+             'lam': lam
+         }
+         
+         # Set up IC parameters based on perturbation type
+         if use_velocity_ps:
+             ic_type = 'power_spectrum'
+             ic_params = {
+                 'power_index': power_index,
+                 'amplitude': vel_rms,
+                 'random_seed': unique_seed
+             }
+         else:
+             ic_type = 'sinusoidal'
+             ic_params = {
+                 'KX': kx,
+                 'KY': ky
+             }
+         
+         options = {
+             'gravity': gravity,
+             'nu': nu,
+             'comparison': False,
+             'isplot': False
+         }
+         
+         # Call unified solver
+         result = lax_solver_torch(
+             time=time,
+             domain_params=domain_params,
+             physics_params=physics_params,
+             ic_type=ic_type,
+             ic_params=ic_params,
+             options=options
+         )
+         
+         # Extract values from SimulationResult
+         x = result.coordinates['x']
+         rho = result.density
+         vx, vy = result.velocity_components
+         phi = result.potential
+         n = result.metadata['iterations']
+         rho_max = result.metadata['rho_max']
+         
          # LAX solver returns x starting from 0, so offset by xmin
          x = x + xmin
```

</details>

</tool-use>

---

Now let me check for any linter errors:

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `utilities/analyze_numerical.py`

Lint results

Lint errors for `utilities/analyze_numerical.py`


| Message | Range | Severity |
|-------|-------|----------|
| Import "generate_velocity_field_power_spectrum" is not accessed | 25:69-25:107 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "n" is not accessed | 155:9-155:10 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "n" is not accessed | 184:34-184:35 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "n" is not accessed | 192:13-192:14 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "x" is not accessed | 268:17-268:18 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "y" is not accessed | 268:20-268:21 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "vx" is not accessed | 268:28-268:30 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "vy" is not accessed | 268:32-268:34 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "phi" is not accessed | 268:36-268:39 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "rho_max" is not accessed | 268:41-268:48 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "phi" is not accessed | 335:28-335:31 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "rho_max" is not accessed | 335:33-335:40 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "ax_dens" is not accessed | 347:23-347:30 | DIAGNOSTIC_SEVERITY_HINT |
| Variable "ax_vel" is not accessed | 365:22-365:28 | DIAGNOSTIC_SEVERITY_HINT |


</details>
</tool-use>

---

Great! Now let me verify the changes by reading the updated section to make sure everything looks correct:

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: utilities/analyze_numerical.py</summary>

</details>
</tool-use>

---

Perfect! The changes look good. Let me create a quick summary of what was changed:

## Summary

I've successfully modified `utilities/analyze_numerical.py` to use the new `lax_solver_torch()` function instead of the deprecated `lax_solution_torch()`. Here are the key changes:

### Changes Made:

1. **Updated import statement** (line 26):
   - Changed from: `from numerical_solvers.LAX_torch import lax_solution_torch`
   - Changed to: `from numerical_solvers.LAX_torch import lax_solver_torch`

2. **Updated the PyTorch solver call** (lines 100-159):
   - Replaced the old `lax_solution_torch()` call with the new unified `lax_solver_torch()` API
   - Created proper parameter dictionaries:
     - `domain_params`: Contains domain size and grid resolution (`Lx`, `Ly`, `nx`, `ny`)
     - `physics_params`: Contains physical constants (`c_s`, `rho_o`, `const`, `G`, `rho_1`, `lam`)
     - `ic_params`: Contains initial condition parameters (either power spectrum or sinusoidal)
     - `options`: Contains solver options (`gravity`, `nu`, `comparison`, `isplot`)
   - Properly extracted results from the new `SimulationResult` dataclass:
     - Coordinates from `result.coordinates['x']`
     - Density from `result.density`
     - Velocities from `result.velocity_components`
     - Potential from `result.potential`
     - Metadata from `result.metadata`

The script now uses the modern, unified API while maintaining all the same functionality. The changes are backward compatible with the rest of the script's logic, and no linter errors were introduced.

---

