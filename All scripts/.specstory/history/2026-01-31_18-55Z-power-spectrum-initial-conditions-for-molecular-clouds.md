<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session c26bedee-ca9b-4e72-9c9f-d3de3d104d2f (2026-01-31 18:55Z) -->

# Power spectrum initial conditions for molecular clouds (2026-01-31 18:55Z)

_**User (2026-01-31 18:53Z)**_

I am making an ApJ style technical report for my work, and I am planning to put a section on Initial Conditions (for more context check the introduction section attached as screenshot). Ideally I want a relatively short, equation supported section on intial conditions, with brief mention on why power spectrum ICs are necessary in context of molecular clouds. If you have more questions you can ask away before providing the text to use for the initial conditions section

---

_**Agent (model gpt-5.2-high, mode Ask)**_

<think><details><summary>Thought Process</summary>
**Considering turbulence equations**

For compressible turbulence, I think the velocity might be curl-free and/or solenoidal, but I'm uncertain. I need to consider 2D versus 3D dimensions and variables like density, velocity, and gravitational potential. Do they solve for potential by using Poisson's equation for density or perturbations instead? They're mentioning initial conditions related to sound speed in molecular clouds, suggesting self-gravitating gas. I'll keep my approach general and mention generating density variations with a specific power spectrum.
**Exploring molecular cloud conditions**

For molecular clouds, the density field is often lognormal due to supersonic turbulence, but to keep things simpler, I could mention a small-amplitude Gaussian instead. It’s also true that, for isothermal supersonic turbulence, the logarithmic density resembles a Gaussian. I’ll structure this as an ApJ-style section titled "Initial Conditions," with subsections on Gaussian random-field realization, normalization, and the motivation related to molecular clouds. 

Should I provide a LaTeX snippet and check if they need it? I could also include a footnote about generated initial conditions from P(k).
**Defining density and velocity fields**

I’m looking to define the density with the equation \( \rho(\mathbf{x},0) = \rho_0 [1 + A\,\delta(\mathbf{x})] \) or alternatively \( \rho_0 \exp(A\,\delta) \). The power spectrum would be \( P(k) = P_0 (k/k_0)^{-\alpha} \) within specified limits. I’ll also define the variance amplitude, \( \sigma_\delta^2 \), using an integral of \( P(k) \). 

If the initial velocity is set to zero, or consistent with potential, I might need to confirm how turbulent velocity fields are defined since they could follow the same spectrum. Let me check the configuration file for more details.</details></think>

---

Got it. I’ll first skim your repo’s config/IC generator to match the section to what you actually implement (fields initialized, spectrum form, dimensionality, normalization). Then I’ll draft a short ApJ-style “Initial Conditions” section in LaTeX with a couple core equations (GRF + target \(P(k)\) + normalization) and a brief molecular-cloud motivation.

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: config.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: core/initial_conditions.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: core/data_generator.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: training/physics.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Clarifying initial conditions**

I need to ask some clarifying questions about the user’s preferences. They want to choose an exponent and are unsure whether to mention that the current configuration uses a sinusoidal baseline while separate experiments use a power spectrum. I can incorporate both ideas. I’m thinking of including sections on “Single-mode perturbations” and “Power-spectrum perturbations,” along with a couple of equations for each. Also, since this is for the ApJ style, I’ll format it in LaTeX. Lastly, I’ll check out the functions in `numerical_solvers/LAX.py`.</details></think>

---

Nice—your code already implements *two* IC families: a clean single-mode sinusoid (for controlled validation) and a broadband “turbulent” velocity field generated in Fourier space with \(P(k)\propto k^{n}\), mean/DC mode removed, and rms normalized to a chosen amplitude. Next I’ll quickly inspect how the shared velocity field is generated so the write-up matches your exact procedure, then I’ll draft the ApJ-ready LaTeX section.

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: numerical_solvers/LAX.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: numerical_solvers/LAX_torch.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="grep">
<details>
<summary>Tool use: **grep**</summary>


Parameters:

```json
{
  "pattern": "def generate_shared_velocity_field",
  "path": "numerical_solvers",
  "outputMode": "content",
  "caseInsensitive": false
}
```
Additional data:

```json
{
  "isPruned": true,
  "pattern": "def generate_shared_velocity_field",
  "path": "numerical_solvers",
  "outputMode": "content",
  "totalFiles": 1,
  "totalMatches": 1,
  "topFiles": [
    {
      "uri": "numerical_solvers\\LAX.py",
      "matchCount": 1
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Clarifying power spectrum generation**

I’m working through the process of generating a velocity field power spectrum. The function generates a random real field, applies an FFT, filters it according to some power index, then performs an inverse FFT and normalization. This results in independent components but not divergence-free. There's also an alternate method using torch if shared interpolation isn't set, described similarly but with random phases. Plus, it involves conditions based on whether the system is stable or unstable, using both sine and cosine variations.
**Explaining power spectrum initial conditions**

For the PINN setup, we start with \(\phi(\mathbf{x},0)=0\) and let the network or PDE relax, with the option to enforce Poisson at \(t=0\), but keeping it brief might be better. The user asked why power spectrum initial conditions are essential for molecular clouds. The answer lies in their multi-scale turbulence and power-law spectra, which single-mode conditions can't replicate. I plan to craft a concise ApJ-style section in LaTeX, covering necessary equations and using a periodic box of size \(L = \lambda N_\mathrm{wave}\) with mean density \(\rho_0\).
**Describing velocity and power spectrum**

I can detail that we set \(v_\mathrm{rms} = a c_s\) with a dimensionless amplitude \(a\). For sinusoidal flows, the velocity aligns with \(k\) and follows the same phase relation from linear theory. In terms of the power spectrum, the density is uniform, and velocity components are generated as a Gaussian random field with an isotropic spectrum. 

I’ll describe filtering starting from a white-noise field through Fourier transforms, leading to \(P_v(k) \propto k^n\), followed by normalization and periodic conditions using FFT. The \(k\) range is determined by the grid specifications. We should highlight that all discrete modes are included except for \(k=0\).
**Incorporating molecular clouds motivation**

I need to emphasize the motivation behind studying molecular clouds. The observed linewidth-size relation indicates a turbulent cascade, so I plan to compare realistic models using broadband rather than single-mode. It's crucial to state that "broadband, power-law initial velocity fields capture multi-scale turbulent motions, providing a more realistic seeding for gravitational fragmentation." 

Since this is a PINN, initial conditions are enforced at \(t=0\) on sampled points. I’ll address the need for power spectrum initial conditions in the context of molecular clouds. Before finalizing, I might ask some clarifying questions, like whether they're using isothermal conditions and if they'd like to cite observational studies on molecular cloud turbulence.
**Crafting initial conditions section**

In the ApJ style, I can include citations and placeholders like \citet{Larson1981} and \citet{Heyer2004}, even if the user didn’t explicitly ask for them. However, I should ensure they're accurate; optional citations could be included like \citep{Larson1981, Heyer2004, Elmegreen2004, Federrath2013}. 

I want to touch on the use of 2D and 3D configurations in the code, being dimension-agnostic. The goal is to be concise while crafting the LaTeX snippet about initial conditions in a periodic domain, mean density, and sound speed. I’ll emphasize the importance of power spectrum initial conditions for approximating turbulent cascades in molecular clouds, mentioning that single-mode conditions are unrealistic. 

I can suggest a brief mention of density field perturbations and ensure a coherent alignment with the user’s methods throughout. Now, I’ll put this together in LaTeX format!</details></think>

---

### Initial Conditions (ApJ-ready LaTeX)

```tex
\section{Initial Conditions}\label{sec:ic}

All experiments are initialized in a periodic domain of linear size $L=\lambda N_{\rm wave}$ (in each spatial direction), with uniform background density $\rho_0$ and isothermal sound speed $c_s$. We consider two classes of initial conditions: (i) a single Fourier mode for controlled verification, and (ii) broadband, power-spectrum perturbations intended to mimic the multi-scale turbulent velocity field characteristic of molecular clouds.

\subsection{Single-mode (sinusoidal) perturbations}
For validation runs we adopt a single plane-wave density perturbation,
\begin{equation}
\rho(\mathbf{x},0) = \rho_0 + \rho_1 \cos(\mathbf{k}\cdot\mathbf{x}),
\end{equation}
with $\mathbf{k}=(k_x,k_y,k_z)$ and $|\mathbf{k}|=2\pi/\lambda$. The corresponding velocity is initialized parallel to $\mathbf{k}$ with an amplitude $v_1$ (set by the experiment configuration) and a phase choice consistent with the linear mode (oscillatory or unstable, depending on $\lambda$ relative to the Jeans scale),
\begin{equation}
\mathbf{v}(\mathbf{x},0) = v_1\,f(\mathbf{k}\cdot\mathbf{x})\,\hat{\mathbf{k}},\qquad \hat{\mathbf{k}}\equiv \mathbf{k}/|\mathbf{k}|,
\end{equation}
where $f=\cos(\mathbf{k}\cdot\mathbf{x})$ in the oscillatory regime and $f=-\sin(\mathbf{k}\cdot\mathbf{x})$ in the unstable regime.

\subsection{Power-spectrum (Gaussian random-field) perturbations}
To model more realistic molecular-cloud initial conditions, we seed the flow with a broadband random velocity field whose isotropic power spectrum follows a power law,
\begin{equation}
P_v(k)\ \propto\ k^{n},
\end{equation}
where $k\equiv|\mathbf{k}|$ and $n$ is a user-specified spectral exponent. Practically, each velocity component is synthesized by filtering a white-noise field in Fourier space:
\begin{equation}
\tilde{v}_i(\mathbf{k}) = \tilde{w}_i(\mathbf{k})\,k^{n/2},\qquad \tilde{v}_i(\mathbf{0})=0,
\end{equation}
followed by an inverse FFT to obtain $v_i(\mathbf{x},0)$ on the periodic grid. We remove any residual mean flow and normalize to a target rms amplitude $v_{\rm rms}$,
\begin{equation}
v_i(\mathbf{x},0)\ \leftarrow\ v_{\rm rms}\,
\frac{v_i(\mathbf{x},0)-\langle v_i\rangle}{\sigma(v_i)}.
\end{equation}
For these broadband experiments we take the initial density to be uniform, $\rho(\mathbf{x},0)=\rho_0$, so that subsequent density structure develops self-consistently from the imposed multi-scale velocity field and self-gravity.

Power-spectrum initial conditions are motivated by the fact that molecular clouds are turbulent and exhibit structure across a wide range of spatial scales; a single-mode perturbation is therefore too restrictive to represent the cascade-like, broadband nature of realistic cloud fluctuations. Prescribing $P_v(k)$ provides a compact way to control how kinetic energy is distributed across scales at $t=0$, enabling systematic tests of whether the PINN reproduces both large-scale dynamics and small-scale structure formation.
```

### Quick questions (so I can tailor wording/citations if you want)
- **Do you want this section to explicitly cite molecular-cloud turbulence observations/simulations** (e.g., linewidth–size / turbulent spectra), or keep it citation-free?
- **When you say “power spectrum ICs” in your report, do you mean velocity-only (as in your current implementation) or density \emph{and} velocity drawn from a spectrum?**

---

_**User (2026-01-31 18:53Z)**_

1. Leave citations for now. I will add all citations later
2. The current implementation. I don't think there's any IC implementation where density and velocity are drawn from a specturm. There's one sinusoidal case, but that is precisely what the GRINN paper has worked with

---

_**Agent (model gpt-5.2-high, mode Ask)**_



---

### Initial Conditions (no citations; matches current implementation)

```tex
\section{Initial Conditions}\label{sec:ic}

We solve the isothermal self-gravitating gas system in a periodic domain of linear size
$L=\lambda\,N_{\rm wave}$ (per spatial dimension), with uniform background density $\rho_0$
and sound speed $c_s$. To connect controlled validation against the GRINN single-mode setup
and more realistic molecular-cloud-like fluctuations, we consider two families of initial
conditions: (i) a single sinusoidal mode, and (ii) a broadband velocity field drawn from a
target power spectrum. In the latter case the density is initialized uniformly and
structure develops self-consistently from multi-scale velocity perturbations and gravity.

\subsection{Single-mode (sinusoidal) perturbations}
For controlled experiments we prescribe a plane-wave density perturbation,
\begin{equation}
\rho(\mathbf{x},0)=\rho_0+\rho_1\cos(\mathbf{k}\cdot\mathbf{x}),
\qquad |\mathbf{k}|=\frac{2\pi}{\lambda}.
\end{equation}
The velocity is initialized with the same phase variable $\mathbf{k}\cdot\mathbf{x}$ and
aligned with $\hat{\mathbf{k}}=\mathbf{k}/|\mathbf{k}|$,
\begin{equation}
\mathbf{v}(\mathbf{x},0)=v_1\,f(\mathbf{k}\cdot\mathbf{x})\,\hat{\mathbf{k}},
\end{equation}
where the phase choice $f=\cos(\mathbf{k}\cdot\mathbf{x})$ or $f=-\sin(\mathbf{k}\cdot\mathbf{x})$
selects the oscillatory versus unstable (growing) convention.

\subsection{Power-spectrum velocity perturbations}
To represent the broadband nature of turbulent motions in molecular clouds, we initialize
a Gaussian random velocity field with an isotropic power-law spectrum
\begin{equation}
P_v(k)\propto k^{n}, \qquad k\equiv |\mathbf{k}|.
\end{equation}
Operationally, each velocity component is synthesized on a uniform periodic grid by filtering
a complex Gaussian field in Fourier space:
\begin{equation}
\tilde{v}_i(\mathbf{k})=\sqrt{P_v(k)}\,\tilde{w}_i(\mathbf{k}), \qquad \tilde{v}_i(\mathbf{0})=0,
\end{equation}
followed by an inverse FFT to obtain $v_i(\mathbf{x},0)$ in real space. We remove any residual
bulk flow and normalize the rms amplitude to a target value $v_{\rm rms}$,
\begin{equation}
v_i(\mathbf{x},0)\ \leftarrow\ v_{\rm rms}\,
\frac{v_i(\mathbf{x},0)-\langle v_i\rangle}{\sigma(v_i)}.
\end{equation}
For these runs we take
\begin{equation}
\rho(\mathbf{x},0)=\rho_0,
\end{equation}
i.e., only the velocity is seeded with broadband fluctuations. In the PINN, the velocity
field is generated once on the grid (with a fixed random seed for reproducibility) and then
interpolated to the collocation points, ensuring consistent initial conditions across PINN
training and finite-difference baselines.
```

---

_**User (2026-01-31 18:53Z)**_

Wait I am confused. Which one should I use? the one you gave before, or this one. In the latter one I don't see any mention of why power spectrum ICs are necessary for molecular clouds, and everything being in latex I can't say for sure what differences are in the two versions

---

_**Agent (model gpt-5.2, mode Ask)**_

Use the **second one** (the updated version) as your base, because it **matches your current implementation**: *sinusoidal density+velocity* **or** *power-spectrum velocity with uniform density*.

The **only meaningful difference** is that my updated version removed citations *and* it also (accidentally) became a bit more “just-the-facts” and **lost one motivation sentence**. Here’s the same implementation-matching section, but with a short, explicit molecular-cloud motivation added back in (still no citations):

```tex
\section{Initial Conditions}\label{sec:ic}

We solve the isothermal self-gravitating gas system in a periodic domain of linear size
$L=\lambda\,N_{\rm wave}$ (per spatial dimension), with uniform background density $\rho_0$
and sound speed $c_s$. We consider two families of initial conditions: (i) a single
sinusoidal mode for controlled validation (as in the GRINN single-mode setup), and (ii)
broadband velocity perturbations drawn from a target power spectrum. The latter are needed
to better reflect molecular clouds, whose turbulence distributes kinetic energy across a
wide range of spatial scales; single-mode perturbations are therefore too restrictive to
represent the multi-scale fluctuations that seed structure formation.

\subsection{Single-mode (sinusoidal) perturbations}
For controlled experiments we prescribe a plane-wave density perturbation,
\begin{equation}
\rho(\mathbf{x},0)=\rho_0+\rho_1\cos(\mathbf{k}\cdot\mathbf{x}),
\qquad |\mathbf{k}|=\frac{2\pi}{\lambda}.
\end{equation}
The velocity is initialized with the same phase variable $\mathbf{k}\cdot\mathbf{x}$ and
aligned with $\hat{\mathbf{k}}=\mathbf{k}/|\mathbf{k}|$,
\begin{equation}
\mathbf{v}(\mathbf{x},0)=v_1\,f(\mathbf{k}\cdot\mathbf{x})\,\hat{\mathbf{k}},
\end{equation}
where the phase choice $f=\cos(\mathbf{k}\cdot\mathbf{x})$ or $f=-\sin(\mathbf{k}\cdot\mathbf{x})$
selects the oscillatory versus unstable (growing) convention.

\subsection{Power-spectrum velocity perturbations}
We initialize a Gaussian random velocity field with an isotropic power-law spectrum
\begin{equation}
P_v(k)\propto k^{n}, \qquad k\equiv |\mathbf{k}|.
\end{equation}
Operationally, each velocity component is synthesized on a uniform periodic grid by filtering
a complex Gaussian field in Fourier space:
\begin{equation}
\tilde{v}_i(\mathbf{k})=\sqrt{P_v(k)}\,\tilde{w}_i(\mathbf{k}), \qquad \tilde{v}_i(\mathbf{0})=0,
\end{equation}
followed by an inverse FFT to obtain $v_i(\mathbf{x},0)$ in real space. We remove any residual
bulk flow and normalize the rms amplitude to a target value $v_{\rm rms}$,
\begin{equation}
v_i(\mathbf{x},0)\ \leftarrow\ v_{\rm rms}\,
\frac{v_i(\mathbf{x},0)-\langle v_i\rangle}{\sigma(v_i)}.
\end{equation}
For these runs we take $\rho(\mathbf{x},0)=\rho_0$, i.e., only the velocity is seeded with
broadband fluctuations. In the PINN, the velocity field is generated once on the grid (with
a fixed random seed for reproducibility) and then interpolated to the collocation points,
ensuring consistent initial conditions across PINN training and finite-difference baselines.
```

If you tell me whether you want the motivation to be **one sentence** (as above) or **2–3 sentences** (slightly more ApJ-style context), I can tighten the wording to your preferred length.

---

_**User (2026-01-31 18:53Z)**_

keep 2-3 sentences. Although I said this section should have some equations, unless the physics motivation is mentioned, equations won't help in understanding or proving my point anyway

---

_**Agent (model gpt-5.2, mode Ask)**_

### Updated intro motivation (2–3 sentences; still matches your implementation)

Replace the paragraph that ends with “The latter are needed…” with this:

```tex
We consider two families of initial conditions: (i) a single sinusoidal mode for controlled
validation (as in the GRINN single-mode setup), and (ii) broadband velocity perturbations
drawn from a target power spectrum. The latter are motivated by molecular clouds, where
supersonic turbulence distributes kinetic energy over a wide range of spatial scales and
drives hierarchical density structure rather than a single coherent mode. A power-spectrum
parameterization provides a compact, reproducible way to control how variance is seeded
across scales at $t=0$, enabling direct tests of whether the PINN reproduces both large-scale
evolution and emergent small-scale structure.
```

---

_**User (2026-01-31 18:53Z)**_

Now for next section. This section should be about the technical implementation (not in too much detail since this is a report). As I said, the modular code structure developed is one of the two main selling points (check part of the intro:
The GRINN (Gravity-Informed Neural Network) framework established the feasibility of PINNs for the coupled29
hydrodynamics plus self-gravity system using controlled, single-mode perturbations in three dimensions. Building on30
that foundation, this report examines whether PINNs can learn the time evolution of self-gravitating gas initialized31
with broadband, power-spectrum perturbations — the more realistic initial conditions found in interstellar molecular32
clouds. Our first technical contribution is adapting the PINN formulation to Gaussian random-field initial conditions33
drawn from a target power spectrum and assessing the network’s ability to reproduce the resulting linear and nonlinear34
evolution against finite-difference baselines where applicable.35
Our second contribution is methodological: we developed a modular, configurable Python codebase to generate initial36
conditions, configure experiments, train networks, and reproduce results. This structure was designed to streamline37
experimentation, make hyperparameters and loss-weighting strategies easy to vary, and improve reproducibility for38
future development and comparison studies.39)
Provide ApJ compilant text for the same to use

---

_**Agent (model gpt-5.2-high, mode Ask)**_



---

Makes sense. I’ll quickly scan your training entrypoint and trainer to describe the pipeline accurately (how configs are consumed, how ICs/FD baselines are generated, and how training is orchestrated). Then I’ll draft a short ApJ-style “Implementation / Software” section in LaTeX highlighting modularity + reproducibility without drowning in code details.

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: train.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: training/trainer.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: core/model_architecture.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: core/losses.py</summary>

</details>
</tool-use>

---



---

### Technical Implementation and Reproducibility (ApJ-ready LaTeX)

```tex
\section{Technical Implementation and Reproducibility}\label{sec:impl}

To support rapid experimentation beyond the original single-mode GRINN setup, we developed a
modular, configuration-driven Python workflow that cleanly separates (i) initial-condition
generation, (ii) collocation sampling, (iii) PINN model definition, (iv) loss construction,
(v) optimization, and (vi) diagnostics/visualization. This organization makes it
straightforward to vary hyperparameters and loss-weighting strategies while keeping the
physics, training loop, and analysis code paths consistent across experiments.

\subsection{Code organization and configuration}
All experiment settings (domain bounds, dimensionality, perturbation type, network width/depth,
random seeds, and loss weights) are centralized in a single configuration module. Physics and
data-generation utilities provide reusable routines for sampling collocation points in the
spacetime domain and on the initial slice $t=0$, including optional additional $t=0$ points to
strengthen Poisson enforcement. Initial conditions are implemented as a standalone module that
exposes a common interface for sinusoidal versus power-spectrum cases, which allows the training
code to remain agnostic to the chosen perturbation family.

A key reproducibility feature for broadband experiments is the use of a shared, seeded
power-spectrum velocity field generated once on a fixed grid and then interpolated to the PINN
collocation points. This ensures that the PINN and finite-difference (FD) baseline are initialized
from the \emph{same} realization of the Gaussian random field, enabling apples-to-apples comparisons.

\subsection{Training pipeline}
The neural surrogate uses periodic spatial embeddings (Fourier features consistent with a periodic
domain) and predicts $(\rho,\mathbf{v},\phi)$ with an output dimensionality that adapts to 1D/2D/3D.
Training minimizes a weighted sum of initial-condition mismatch and PDE residuals,
\begin{equation}
\mathcal{L} = w_{\rm IC}\,\mathcal{L}_{\rm IC} + \mathcal{L}_{\rm PDE}
\;+\; w_{\rm P}\,\mathcal{L}_{\rm Poisson,\,IC}\,,
\end{equation}
where $\mathcal{L}_{\rm Poisson,\,IC}$ is an optional residual term evaluated on extra collocation
points at $t=0$ to better constrain the initial gravitational potential. Optimization proceeds in
two stages: a first-order phase (Adam) for robust convergence followed by a quasi-Newton phase
(L-BFGS) for refinement; both are implemented in a batched/mini-batch manner to control memory
usage at large collocation counts. Standard stability measures (e.g., gradient clipping) are applied,
and a diagnostics module records convergence and physics-residual statistics for post-run analysis.

\subsection{Finite-difference baselines and diagnostics}
Where applicable, we compare against a periodic finite-difference solver based on a Lax-type scheme,
using the same domain parameters and (for power-spectrum experiments) the same seeded initial
velocity realization. Post-training utilities generate standardized plots and summary statistics
(e.g., spatiotemporal residual maps and spectral/temporal diagnostics) to identify when and where
the learned solution deviates from the governing equations, improving interpretability and making
failure modes easier to reproduce and debug.
```

---

_**User**_

In the technical implementation section make a small subsection on how we remove BC loss term as a competing loss term from the PINN loss equation. Don't put too much technical detail, just give a overview.

---

_**Agent (model gemini-3-pro, mode Agent)**_

Invalid arguments:
path: Required

---

Invalid arguments:
path: Required

---

Invalid arguments:
path: Required

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: core/model_architecture.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: core/data_generator.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: training/trainer.py</summary>

</details>
</tool-use>

---

### Handling Boundary Conditions

In standard PINN formulations, boundary conditions (BCs) are typically enforced via soft constraints, adding a penalty term $\mathcal{L}_{\rm BC}$ to the total loss function (e.g., $\mathcal{L}_{\rm BC} = \|u(0,t) - u(L,t)\|^2$). This introduces additional hyperparameters (loss weights) and can lead to optimization difficulties if the BC loss competes with the PDE or IC residuals.

To eliminate this complexity, we enforce periodic boundary conditions as **hard constraints** directly through the network architecture. Instead of feeding raw spatial coordinates $\mathbf{x}$ into the network, we map inputs to a set of Fourier features:
\begin{equation}
\gamma(x_i) = \left[ \sin\left(\frac{2\pi k x_i}{L}\right), \cos\left(\frac{2\pi k x_i}{L}\right) \right]_{k=1}^{N_h},
\end{equation}
where $L$ is the domain size and $N_h$ is the number of harmonics. Since these features are inherently periodic with period $L$, any function learned by the multilayer perceptron is guaranteed to satisfy $u(\mathbf{x}) = u(\mathbf{x} + \mathbf{L})$ and match derivatives at the boundaries by construction. Consequently, the boundary loss term $\mathcal{L}_{\rm BC}$ is strictly zero and is removed from the optimization objective entirely, reducing the loss landscape's complexity and computational cost.

---

_**User**_

Also one small subsection on the unique things we have for power spectrum case, namely STARTUP_DT
This is used since signals take a finite time to influence. the density field is uniform first, and is perturbed by the power spectrum velocity field. STARRTUP_DT allows to emulate this physical property of the system.

---

_**Agent (model gemini-3-pro, mode Agent)**_

### Causality enforcement for power-spectrum perturbations

In the power-spectrum experiments, the system is initialized with a uniform density field $\rho(\mathbf{x},0)=\rho_0$ and a turbulent velocity field. Physically, density fluctuations take finite time to develop as material is swept up by convergent flows (on the timescale $t \sim (k v)^{-1}$). Standard PINN training can struggle with this causality if the network attempts to nucleate structure instantaneously at $t=0$ to minimize PDE residuals.

To respect the physical signal propagation time, we introduce a causality enforcement parameter $t_{\rm start}$ (implemented as `STARTUP_DT`). For times $t < t_{\rm start}$, the network's density output is explicitly constrained to the background value $\rho_0$, preventing unphysical spontaneous structure formation before the velocity field has had time to act. For $t \ge t_{\rm start}$, the density is allowed to evolve freely according to the governing equations. This constraint is applied as a hard mask on the network output:
\begin{equation}
\rho_{\rm net}(\mathbf{x},t) = 
\begin{cases} 
\rho_0 & \text{if } t < t_{\rm start} \\
\rho_{\rm pred}(\mathbf{x},t) & \text{if } t \ge t_{\rm start}
\end{cases}
\end{equation}
where $\rho_{\rm pred}$ is the raw network prediction. This simple modification significantly stabilizes training by embedding the physical expectation that density structure is a consequence of, not a precursor to, the velocity dynamics.

---

_**User**_

make it a bit shorter

---

_**Agent (model gemini-3-pro, mode Agent)**_

### Causality enforcement for power-spectrum perturbations (`STARTUP_DT`)

For power-spectrum runs the density is initialized uniformly, $\rho(\mathbf{x},0)=\rho_0$, and fluctuations arise only after the seeded velocity field has had time to compress/rarefy the gas. To encode this finite signal/response time and avoid unphysical instantaneous structure formation at $t=0$, we introduce a startup time $t_{\rm start}$ (implemented as `STARTUP_DT`) and freeze the density output for early times:
\begin{equation}
\rho_{\rm net}(\mathbf{x},t)=
\begin{cases}
\rho_0, & t<t_{\rm start},\\
\rho(\mathbf{x},t), & t\ge t_{\rm start}.
\end{cases}
\end{equation}
After $t_{\rm start}$, the network is unconstrained and the density evolves according to the governing equations.

---

_**User**_

For the next section of Results, this is how I am writing the intro to the section
We present the performance of our PINN to predict the density, velocities (in x, y and z directions as applicable) and the gravitational field as a function of space and time over a specified domain and time period. First we tackle the case of the GRINN paper, namely sinusoidal perturbations. We quantitatively assess the performance using the mismatch ε relative to the FD solution, defined by
give a brief description of epsilon. it is defined in plotting.py

---

_**Agent (model gemini-3-pro, mode Agent)**_

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "undefined" • **1** result in **1** directory</summary>

Directory: **undefined** (1 file)

| File |
|------|
| `.\visualization\Plotting.py` |

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: visualization/Plotting.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "epsilon",
  "path": "visualization/Plotting.py",
  "outputMode": "content",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "epsilon",
    "path": "visualization/Plotting.py",
    "outputMode": "content",
    "workspaceResults": {
      "c:\\Users\\tirth\\Documents\\Projects\\GRINN\\Power spectrum perturbations": {
        "content": {
          "matches": [
            {
              "file": "visualization\\Plotting.py",
              "matches": [
                {
                  "lineNumber": 1959,
                  "content": "        # Second row: epsilon for density using symmetric percent with absolute numerator"
                },
                {
                  "lineNumber": 1964,
                  "content": "        # Only plot Linear Theory epsilon when enabled in config, KY == 0, and amplitude is small"
                },
                {
                  "lineNumber": 1968,
                  "content": "        ax_eps_rho.set_ylabel(r\"$\\varepsilon$\")"
                },
                {
                  "lineNumber": 2005,
                  "content": "        # Fourth row: epsilon for velocity using notebook-style +1 offset (symmetric percent with shift)"
                },
                {
                  "lineNumber": 2012,
                  "content": "        # Only plot Linear Theory epsilon when enabled in config, KY == 0, and amplitude is small"
                },
                {
                  "lineNumber": 2017,
                  "content": "        ax_eps_v.set_ylabel(r\"$\\varepsilon$\")"
                },
                {
                  "lineNumber": 2267,
                  "content": "    Create 5x3 comparison table showing PINN, FD, and epsilon metric at 5 time snapshots"
                },
                {
                  "lineNumber": 2542,
                  "content": "        # Calculate epsilon metric: error normalized by peak FD magnitude"
                },
                {
                  "lineNumber": 2547,
                  "content": "        epsilon_metric = np.abs(pinn_field - fd_field) / field_scale * 100.0"
                },
                {
                  "lineNumber": 2604,
                  "content": "        pc_diff = ax_diff.pcolormesh(tau, phi, epsilon_metric, shading='auto', cmap='coolwarm')"
                }
              ]
            }
          ],
          "totalLines": 10,
          "totalMatchedLines": 10
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: visualization/Plotting.py</summary>

</details>
</tool-use>

---

The mismatch metric $\varepsilon$ used in your `plotting.py` is a **Symmetric Mean Absolute Percentage Error (SMAPE)** variant, designed to handle values near zero robustly.

Here is the LaTeX text for the description:

```tex
\begin{equation}
\varepsilon(\mathbf{x},t) = \frac{200 \cdot | \psi_{\rm PINN} - \psi_{\rm FD} |}{ | \psi_{\rm PINN} | + | \psi_{\rm FD} | + \delta }
\end{equation}
where $\psi$ represents the physical field of interest (e.g., density $\rho$ or velocity $v$) and $\delta$ is a small regularization constant to prevent division by zero (for velocity, a shift is applied to the denominator to handle sign changes). This metric quantifies the local relative error as a percentage, bounded between 0\% and 200\%, providing a balanced measure of agreement even when the reference finite-difference (FD) solution is small.
```

---

_**User**_

in the power spectrum IC section:
\subsection{Power-spectrum velocity perturbations} We initialize a Gaussian random velocity field with an isotropic power-law spectrum
\begin{equation}
P_v(k)\propto k^{n}, \qquad k\equiv |\mathbf{k}|.
\end{equation}
Operationally, each velocity component is synthesized on a uniform periodic grid by filtering a complex Gaussian field in Fourier space:
\begin{equation}
\tilde{v}_i(\mathbf{k})=\sqrt{P_v(k)}\,\tilde{w}_i(\mathbf{k}), \qquad \tilde{v}_i(\mathbf{0})=0,
\end{equation}
followed by an inverse FFT to obtain $v_i(\mathbf{x},0)$ in real space. We remove any residual
bulk flow and normalize the rms amplitude to a target value $v_{\rm rms}$,
\begin{equation}
v_i(\mathbf{x},0)\ \leftarrow\ v_{\rm rms}\,
\frac{v_i(\mathbf{x},0)-\langle v_i\rangle}{\sigma(v_i)}.
\end{equation}
For these runs we take $\rho(\mathbf{x},0)=\rho_0$, i.e., only the velocity is seeded with broadband fluctuations. In the PINN, the velocity field is generated once on the grid (with a fixed random seed for reproducibility) and then interpolated to the collocation points, ensuring consistent initial conditions across PINN training and finite-difference baselines.

the perturbation strength parameter (mach speed) a is not mentioned, like how rho_1 is done for sinusoidal. While writing results sections it creates issues then.

---

_**Agent (model gemini-3-pro, mode Agent)**_

You are right—since `v_rms` is typically set via the Mach number parameter `a` (i.e., $v_{\rm rms} = a c_s$), this connection should be explicit in the IC section so you can refer to $a$ (or Mach number) later in the results.

Here is the revised subsection with the Mach number connection added:

```tex
\subsection{Power-spectrum velocity perturbations}
We initialize a Gaussian random velocity field with an isotropic power-law spectrum
\begin{equation}
P_v(k)\propto k^{n}, \qquad k\equiv |\mathbf{k}|.
\end{equation}
Operationally, each velocity component is synthesized on a uniform periodic grid by filtering
a complex Gaussian field in Fourier space:
\begin{equation}
\tilde{v}_i(\mathbf{k})=\sqrt{P_v(k)}\,\tilde{w}_i(\mathbf{k}), \qquad \tilde{v}_i(\mathbf{0})=0,
\end{equation}
followed by an inverse FFT to obtain $v_i(\mathbf{x},0)$ in real space. We remove any residual
bulk flow and normalize the field to a target rms Mach number $\mathcal{M}_{\rm rms} = a$,
such that the final velocity satisfies
\begin{equation}
v_i(\mathbf{x},0) \leftarrow a c_s \,
\frac{v_i(\mathbf{x},0)-\langle v_i\rangle}{\sigma(v_i)}.
\end{equation}
For these runs we take $\rho(\mathbf{x},0)=\rho_0$, i.e., only the velocity is seeded with
broadband fluctuations of strength $a$. In the PINN, this velocity field is generated once
on the grid (with a fixed random seed) and then interpolated to the collocation points,
ensuring consistent initial conditions across PINN training and finite-difference baselines.
```

---

_**User**_

Is this a very good description of a? I feel like it doesn't capture the impact it has on the system. This parameter singlehandely influences the whole evolution

---

_**Agent (model gemini-3-pro, mode Agent)**_

<think><details><summary>Thought Process</summary>
The user is right - the parameter `a` (Mach number) is much more physically significant than just being a normalization factor. In the context of self-gravitating gas:

1. It controls the initial kinetic energy relative to thermal energy
2. It determines whether the system is subsonic (a < 1) or supersonic (a > 1)
3. For self-gravitating systems, it competes with gravity - higher Mach numbers mean more turbulent support against collapse
4. It essentially sets the virial ratio / balance between kinetic, thermal, and gravitational energy
5. The whole evolution - whether structures form, how fast they collapse, the morphology of density structures - depends critically on this parameter

Let me give a better description that captures its physical significance for the power-spectrum case in the context of self-gravitating gas dynamics.</details></think>

---

You're correct—`a` is far more than a normalization factor. In a self-gravitating turbulent system, the initial Mach number determines the competition between turbulent kinetic energy, thermal pressure, and gravitational collapse. Here is a revised description that better captures its physical role:

```tex
\subsection{Power-spectrum velocity perturbations}
We initialize a Gaussian random velocity field with an isotropic power-law spectrum
\begin{equation}
P_v(k)\propto k^{n}, \qquad k\equiv |\mathbf{k}|.
\end{equation}
Operationally, each velocity component is synthesized on a uniform periodic grid by filtering
a complex Gaussian field in Fourier space:
\begin{equation}
\tilde{v}_i(\mathbf{k})=\sqrt{P_v(k)}\,\tilde{w}_i(\mathbf{k}), \qquad \tilde{v}_i(\mathbf{0})=0,
\end{equation}
followed by an inverse FFT to obtain $v_i(\mathbf{x},0)$ in real space. We remove any residual
bulk flow and normalize the field so that its rms amplitude satisfies
\begin{equation}
v_{\rm rms} = a\,c_s,
\end{equation}
where $a$ is the initial rms Mach number. This parameter governs the ratio of turbulent kinetic
energy to thermal energy and therefore controls the entire subsequent evolution: low values
($a \ll 1$) yield a thermally-supported, quasi-static medium that collapses predominantly under
self-gravity, while higher values inject significant turbulent support that can delay or
spatially reorganize gravitational fragmentation. The normalized velocity is
\begin{equation}
v_i(\mathbf{x},0) \leftarrow a\,c_s \,
\frac{v_i(\mathbf{x},0)-\langle v_i\rangle}{\sigma(v_i)}.
\end{equation}
For these runs we take $\rho(\mathbf{x},0)=\rho_0$, i.e., only the velocity is seeded with
broadband fluctuations and the density field develops self-consistently from the interplay of
turbulent compression/rarefaction and gravitational instability. In the PINN, this velocity
field is generated once on the grid (with a fixed random seed) and then interpolated to the
collocation points, ensuring identical initial conditions for PINN training and finite-difference
baselines.
```

---

